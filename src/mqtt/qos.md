---
title: mqtt 消息质量 QoS
icon: spinner
order: 6
---

## 科普视频

- [mqtt科普、mqttx、mica-mqtt的使用**视频**](https://www.bilibili.com/video/BV1wv4y1F7Av/)

## mqtt 消息质量 QoS

在MQTT协议中，选择合适的QoS（服务质量）等级取决于数据上报的具体场景和需求。以下是针对不同QoS等级的分析和建议：

---

### **1. QoS 0（最多一次）**
- **特点**：消息发送后不保留、不确认，可能丢失。
- **适用场景**：
    - **高频低重要性数据**：如周期性传感器数据（温度、湿度等），允许偶发丢失。
    - **网络稳定且资源受限**：设备电量低或带宽有限时（如电池供电的IoT设备）。
    - **实时性要求高**：如实时监控仪表盘，短暂数据丢失不影响整体趋势。
- **不适用场景**：关键报警、计费数据或必须保证到达的场景。

---

### **2. QoS 1（至少一次）**
- **特点**：确保消息到达，但可能有重复。
- **适用场景**：
    - **关键但允许重复的数据**：如设备状态变更（开关机）、报警信息。
    - **网络不稳定但需可靠性**：需容忍重复但必须保证数据到达（需服务端去重）。
    - **中等资源设备**：设备和服务端能处理消息存储和重传。
- **注意事项**：需实现消息去重（如ID去重），避免重复数据干扰业务逻辑。

---

### **3. QoS 2（恰好一次）**
- **特点**：严格保证消息到达且不重复，但开销最大。
- **适用场景**：
    - **关键且不允许重复的数据**：如计费系统、金融交易指令。
    - **高可靠性要求**：如医疗设备的关键指令或工业控制信号。
- **不适用场景**：普通数据上报（资源消耗过高，性价比低）。

---

### **选择建议**

1. **优先 QoS 0 的场景**
    - 高频、海量、允许丢失的数据（如环境传感器每分钟上报一次）。
    - 资源严格受限的终端设备（如NB-IoT、LoRa等低功耗设备）。


2. **推荐 QoS 1 的场景**
    - 在大多数物联网数据上报场景中，QoS 1提供了可靠性（不丢失）与资源消耗的平衡，尤其适合重要但不极端敏感的数据（如设备状态、异常报警）。
    - 需在服务端实现简单的去重逻辑（例如通过消息ID或时间戳）。


3. **谨慎使用 QoS 2**
    - 仅在数据绝对不允许丢失且重复会引发严重问题时使用（如远程设备固件升级指令）。
    - 注意QoS 2会显著增加通信延迟和设备资源消耗。

---

### **其他考虑因素**
- **网络质量**：不稳定网络下优先QoS 1，稳定网络可尝试QoS 0。
- **设备资源**：低功耗设备避免QoS 2，甚至优先QoS 0。
- **业务逻辑容忍度**：能否接受丢失？能否处理重复？根据业务需求反向选择。

---

### **总结**
- **QoS 0**：适用于高频、低重要性、资源受限场景。
- **QoS 1**：平衡选择，适合大多数关键数据上报。
- **QoS 2**：仅用于极端严格场景，需谨慎评估必要性。

### **性能指标（mica-mqtt-client）**

- **QoS 0**：单客户端发送不建议超过 10000 条/秒，避免消息堆积，造成内存溢出。
- **QoS 1**：单客户端发送不建议超过 5000 条/秒，避免重试堆积，造成内存溢出。
- **QoS 2**：单客户端发送不建议超过 3000 条/秒，避免重试堆积，造成内存溢出。

根据实际场景测试不同QoS的稳定性和资源消耗，最终选择性价比最高的方案。
